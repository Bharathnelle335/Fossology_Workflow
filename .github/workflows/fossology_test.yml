name: Fossology Test

on:
  workflow_dispatch:

jobs:
  test-fossology:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create dummy file and tar
        run: |
          echo "hello fossology" > test.txt
          tar -czf input.tar.gz test.txt

      - name: Start Fossology
        run: |
          docker run -d --name fossy -p 8081:80 fossology/fossology
          sleep 60   # wait for DB + services

      - name: Login and save session cookie
        run: |
          curl -v -c cookies.txt -X POST \
               -F "username=fossy" \
               -F "password=fossy" \
               http://localhost:8081/repo/api/v1/login
          echo "---- Cookie file ----"
          cat cookies.txt

      - name: Upload file using session cookie
        run: |
          curl -v -b cookies.txt \
               -F "fileInput=@input.tar.gz" \
               http://localhost:8081/repo/api/v1/uploads > upload.json
          cat upload.json
